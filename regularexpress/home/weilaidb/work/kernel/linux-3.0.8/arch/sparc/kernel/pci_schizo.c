#define DRIVER_NAME	"schizo"
#define PFX		DRIVER_NAME ": "
#define SCHIZO_STRBUF_CTRL_LPTR    0x00000000000000f0UL
#define SCHIZO_STRBUF_CTRL_LENAB   0x0000000000000008UL
#define SCHIZO_STRBUF_CTRL_RRDIS   0x0000000000000004UL
#define SCHIZO_STRBUF_CTRL_DENAB   0x0000000000000002UL
#define SCHIZO_STRBUF_CTRL_ENAB    0x0000000000000001UL
#define SCHIZO_IOMMU_CTRL_RESV     0xfffffffff9000000UL
#define SCHIZO_IOMMU_CTRL_XLTESTAT 0x0000000006000000UL
#define SCHIZO_IOMMU_CTRL_XLTEERR  0x0000000001000000UL
#define SCHIZO_IOMMU_CTRL_LCKEN    0x0000000000800000UL
#define SCHIZO_IOMMU_CTRL_LCKPTR   0x0000000000780000UL
#define SCHIZO_IOMMU_CTRL_TSBSZ    0x0000000000070000UL
#define SCHIZO_IOMMU_TSBSZ_1K      0x0000000000000000UL
#define SCHIZO_IOMMU_TSBSZ_2K      0x0000000000010000UL
#define SCHIZO_IOMMU_TSBSZ_4K      0x0000000000020000UL
#define SCHIZO_IOMMU_TSBSZ_8K      0x0000000000030000UL
#define SCHIZO_IOMMU_TSBSZ_16K     0x0000000000040000UL
#define SCHIZO_IOMMU_TSBSZ_32K     0x0000000000050000UL
#define SCHIZO_IOMMU_TSBSZ_64K     0x0000000000060000UL
#define SCHIZO_IOMMU_TSBSZ_128K    0x0000000000070000UL
#define SCHIZO_IOMMU_CTRL_RESV2    0x000000000000fff8UL
#define SCHIZO_IOMMU_CTRL_TBWSZ    0x0000000000000004UL
#define SCHIZO_IOMMU_CTRL_DENAB    0x0000000000000002UL
#define SCHIZO_IOMMU_CTRL_ENAB     0x0000000000000001UL
#define SCHIZO_CONFIG_BASE(PBM)	((PBM)->config_space)
#define SCHIZO_CONFIG_ENCODE(BUS, DEVFN, REG)	\
(((unsigned long)(BUS)   << 16) |	\
((unsigned long)(DEVFN) << 8)  |	\
((unsigned long)(REG)))
static void *schizo_pci_config_mkaddr(struct pci_pbm_info *pbm,
unsigned char bus,
unsigned int devfn,
int where)
enum schizo_error_type ;
static DEFINE_SPINLOCK(stc_buf_lock);
static unsigned long stc_error_buf[128];
static unsigned long stc_tag_buf[16];
static unsigned long stc_line_buf[16];
#define SCHIZO_UE_INO		0x30
#define SCHIZO_CE_INO		0x31
#define SCHIZO_PCIERR_A_INO	0x32
#define SCHIZO_PCIERR_B_INO	0x33
#define SCHIZO_SERR_INO		0x34
#define SCHIZO_STC_ERR	0xb800UL
#define SCHIZO_STC_TAG	0xba00UL
#define SCHIZO_STC_LINE	0xbb00UL
#define SCHIZO_STCERR_WRITE	0x2UL
#define SCHIZO_STCERR_READ	0x1UL
#define SCHIZO_STCTAG_PPN	0x3fffffff00000000UL
#define SCHIZO_STCTAG_VPN	0x00000000ffffe000UL
#define SCHIZO_STCTAG_VALID	0x8000000000000000UL
#define SCHIZO_STCTAG_READ	0x4000000000000000UL
#define SCHIZO_STCLINE_LINDX	0x0000000007800000UL
#define SCHIZO_STCLINE_SPTR	0x000000000007e000UL
#define SCHIZO_STCLINE_LADDR	0x0000000000001fc0UL
#define SCHIZO_STCLINE_EPTR	0x000000000000003fUL
#define SCHIZO_STCLINE_VALID	0x0000000000600000UL
#define SCHIZO_STCLINE_FOFN	0x0000000000180000UL
static void __schizo_check_stc_error_pbm(struct pci_pbm_info *pbm,
enum schizo_error_type type)
#define SCHIZO_IOMMU_TAG	0xa580UL
#define SCHIZO_IOMMU_DATA	0xa600UL
#define SCHIZO_IOMMU_TAG_CTXT	0x0000001ffe000000UL
#define SCHIZO_IOMMU_TAG_ERRSTS	0x0000000001800000UL
#define SCHIZO_IOMMU_TAG_ERR	0x0000000000400000UL
#define SCHIZO_IOMMU_TAG_WRITE	0x0000000000200000UL
#define SCHIZO_IOMMU_TAG_STREAM	0x0000000000100000UL
#define SCHIZO_IOMMU_TAG_SIZE	0x0000000000080000UL
#define SCHIZO_IOMMU_TAG_VPAGE	0x000000000007ffffUL
#define SCHIZO_IOMMU_DATA_VALID	0x0000000100000000UL
#define SCHIZO_IOMMU_DATA_CACHE	0x0000000040000000UL
#define SCHIZO_IOMMU_DATA_PPAGE	0x000000003fffffffUL
static void schizo_check_iommu_error_pbm(struct pci_pbm_info *pbm,
enum schizo_error_type type)
static void schizo_check_iommu_error(struct pci_pbm_info *pbm,
enum schizo_error_type type)
#define SCHIZO_UE_AFSR	0x10030UL
#define SCHIZO_UE_AFAR	0x10038UL
#define SCHIZO_UEAFSR_PPIO	0x8000000000000000UL
#define SCHIZO_UEAFSR_PDRD	0x4000000000000000UL
#define SCHIZO_UEAFSR_PDWR	0x2000000000000000UL
#define SCHIZO_UEAFSR_SPIO	0x1000000000000000UL
#define SCHIZO_UEAFSR_SDMA	0x0800000000000000UL
#define SCHIZO_UEAFSR_ERRPNDG	0x0300000000000000UL
#define SCHIZO_UEAFSR_BMSK	0x000003ff00000000UL
#define SCHIZO_UEAFSR_QOFF	0x00000000c0000000UL
#define SCHIZO_UEAFSR_AID	0x000000001f000000UL
#define SCHIZO_UEAFSR_PARTIAL	0x0000000000800000UL
#define SCHIZO_UEAFSR_OWNEDIN	0x0000000000400000UL
#define SCHIZO_UEAFSR_MTAGSYND	0x00000000000f0000UL
#define SCHIZO_UEAFSR_MTAG	0x000000000000e000UL
#define SCHIZO_UEAFSR_ECCSYND	0x00000000000001ffUL
static irqreturn_t schizo_ue_intr(int irq, void *dev_id)
#define SCHIZO_CE_AFSR	0x10040UL
#define SCHIZO_CE_AFAR	0x10048UL
#define SCHIZO_CEAFSR_PPIO	0x8000000000000000UL
#define SCHIZO_CEAFSR_PDRD	0x4000000000000000UL
#define SCHIZO_CEAFSR_PDWR	0x2000000000000000UL
#define SCHIZO_CEAFSR_SPIO	0x1000000000000000UL
#define SCHIZO_CEAFSR_SDMA	0x0800000000000000UL
#define SCHIZO_CEAFSR_ERRPNDG	0x0300000000000000UL
#define SCHIZO_CEAFSR_BMSK	0x000003ff00000000UL
#define SCHIZO_CEAFSR_QOFF	0x00000000c0000000UL
#define SCHIZO_CEAFSR_AID	0x000000001f000000UL
#define SCHIZO_CEAFSR_PARTIAL	0x0000000000800000UL
#define SCHIZO_CEAFSR_OWNEDIN	0x0000000000400000UL
#define SCHIZO_CEAFSR_MTAGSYND	0x00000000000f0000UL
#define SCHIZO_CEAFSR_MTAG	0x000000000000e000UL
#define SCHIZO_CEAFSR_ECCSYND	0x00000000000001ffUL
static irqreturn_t schizo_ce_intr(int irq, void *dev_id)
#define SCHIZO_PCI_AFSR	0x2010UL
#define SCHIZO_PCI_AFAR	0x2018UL
#define SCHIZO_PCIAFSR_PMA	0x8000000000000000UL
#define SCHIZO_PCIAFSR_PTA	0x4000000000000000UL
#define SCHIZO_PCIAFSR_PRTRY	0x2000000000000000UL
#define SCHIZO_PCIAFSR_PPERR	0x1000000000000000UL
#define SCHIZO_PCIAFSR_PTTO	0x0800000000000000UL
#define SCHIZO_PCIAFSR_PUNUS	0x0400000000000000UL
#define SCHIZO_PCIAFSR_SMA	0x0200000000000000UL
#define SCHIZO_PCIAFSR_STA	0x0100000000000000UL
#define SCHIZO_PCIAFSR_SRTRY	0x0080000000000000UL
#define SCHIZO_PCIAFSR_SPERR	0x0040000000000000UL
#define SCHIZO_PCIAFSR_STTO	0x0020000000000000UL
#define SCHIZO_PCIAFSR_SUNUS	0x0010000000000000UL
#define SCHIZO_PCIAFSR_BMSK	0x000003ff00000000UL
#define SCHIZO_PCIAFSR_BLK	0x0000000080000000UL
#define SCHIZO_PCIAFSR_CFG	0x0000000040000000UL
#define SCHIZO_PCIAFSR_MEM	0x0000000020000000UL
#define SCHIZO_PCIAFSR_IO	0x0000000010000000UL
#define SCHIZO_PCI_CTRL		(0x2000UL)
#define SCHIZO_PCICTRL_BUS_UNUS	(1UL << 63UL)
#define SCHIZO_PCICTRL_DTO_INT	(1UL << 61UL)
#define SCHIZO_PCICTRL_ARB_PRIO (0x1ff << 52UL)
#define SCHIZO_PCICTRL_ESLCK	(1UL << 51UL)
#define SCHIZO_PCICTRL_ERRSLOT	(7UL << 48UL)
#define SCHIZO_PCICTRL_TTO_ERR	(1UL << 38UL)
#define SCHIZO_PCICTRL_RTRY_ERR	(1UL << 37UL)
#define SCHIZO_PCICTRL_DTO_ERR	(1UL << 36UL)
#define SCHIZO_PCICTRL_SBH_ERR	(1UL << 35UL)
#define SCHIZO_PCICTRL_SERR	(1UL << 34UL)
#define SCHIZO_PCICTRL_PCISPD	(1UL << 33UL)
#define SCHIZO_PCICTRL_MRM_PREF	(1UL << 30UL)
#define SCHIZO_PCICTRL_RDO_PREF	(1UL << 29UL)
#define SCHIZO_PCICTRL_RDL_PREF	(1UL << 28UL)
#define SCHIZO_PCICTRL_PTO	(3UL << 24UL)
#define SCHIZO_PCICTRL_PTO_SHIFT 24UL
#define SCHIZO_PCICTRL_TRWSW	(7UL << 21UL)
#define SCHIZO_PCICTRL_F_TGT_A	(1UL << 20UL)
#define SCHIZO_PCICTRL_S_DTO_INT (1UL << 19UL)
#define SCHIZO_PCICTRL_F_TGT_RT	(1UL << 19UL)
#define SCHIZO_PCICTRL_SBH_INT	(1UL << 18UL)
#define SCHIZO_PCICTRL_T_DTO_INT (1UL << 18UL)
#define SCHIZO_PCICTRL_EEN	(1UL << 17UL)
#define SCHIZO_PCICTRL_PARK	(1UL << 16UL)
#define SCHIZO_PCICTRL_PCIRST	(1UL <<  8UL)
#define SCHIZO_PCICTRL_ARB_S	(0x3fUL << 0UL)
#define SCHIZO_PCICTRL_ARB_T	(0xffUL << 0UL)
static irqreturn_t schizo_pcierr_intr_other(struct pci_pbm_info *pbm)
static irqreturn_t schizo_pcierr_intr(int irq, void *dev_id)
#define SCHIZO_SAFARI_ERRLOG	0x10018UL
#define SAFARI_ERRLOG_ERROUT	0x8000000000000000UL
#define BUS_ERROR_BADCMD	0x4000000000000000UL
#define BUS_ERROR_SSMDIS	0x2000000000000000UL
#define BUS_ERROR_BADMA		0x1000000000000000UL
#define BUS_ERROR_BADMB		0x0800000000000000UL
#define BUS_ERROR_BADMC		0x0400000000000000UL
#define BUS_ERROR_SNOOP_GR	0x0000000000200000UL
#define BUS_ERROR_SNOOP_PCI	0x0000000000100000UL
#define BUS_ERROR_SNOOP_RD	0x0000000000080000UL
#define BUS_ERROR_SNOOP_RDS	0x0000000000020000UL
#define BUS_ERROR_SNOOP_RDSA	0x0000000000010000UL
#define BUS_ERROR_SNOOP_OWN	0x0000000000008000UL
#define BUS_ERROR_SNOOP_RDO	0x0000000000004000UL
#define BUS_ERROR_CPU1PS	0x0000000000002000UL
#define BUS_ERROR_WDATA_PERR	0x0000000000002000UL
#define BUS_ERROR_CPU1PB	0x0000000000001000UL
#define BUS_ERROR_CTRL_PERR	0x0000000000001000UL
#define BUS_ERROR_CPU0PS	0x0000000000000800UL
#define BUS_ERROR_SNOOP_ERR	0x0000000000000800UL
#define BUS_ERROR_CPU0PB	0x0000000000000400UL
#define BUS_ERROR_JBUS_ILL_B	0x0000000000000400UL
#define BUS_ERROR_CIQTO		0x0000000000000200UL
#define BUS_ERROR_LPQTO		0x0000000000000100UL
#define BUS_ERROR_JBUS_ILL_C	0x0000000000000100UL
#define BUS_ERROR_SFPQTO	0x0000000000000080UL
#define BUS_ERROR_UFPQTO	0x0000000000000040UL
#define BUS_ERROR_RD_PERR	0x0000000000000040UL
#define BUS_ERROR_APERR		0x0000000000000020UL
#define BUS_ERROR_UNMAP		0x0000000000000010UL
#define BUS_ERROR_BUSERR	0x0000000000000004UL
#define BUS_ERROR_TIMEOUT	0x0000000000000002UL
#define BUS_ERROR_ILL		0x0000000000000001UL
static irqreturn_t schizo_safarierr_intr(int irq, void *dev_id)
#define SCHIZO_ECC_CTRL		0x10020UL
#define  SCHIZO_ECCCTRL_EE	 0x8000000000000000UL
#define  SCHIZO_ECCCTRL_UE	 0x4000000000000000UL
#define  SCHIZO_ECCCTRL_CE	 0x2000000000000000UL
#define SCHIZO_SAFARI_ERRCTRL	0x10008UL
#define  SCHIZO_SAFERRCTRL_EN	 0x8000000000000000UL
#define SCHIZO_SAFARI_IRQCTRL	0x10010UL
#define  SCHIZO_SAFIRQCTRL_EN	 0x8000000000000000UL
static int pbm_routes_this_ino(struct pci_pbm_info *pbm, u32 ino)
static void tomatillo_register_error_handlers(struct pci_pbm_info *pbm)
static void schizo_register_error_handlers(struct pci_pbm_info *pbm)
static void pbm_config_busmastering(struct pci_pbm_info *pbm)
static void __devinit schizo_scan_bus(struct pci_pbm_info *pbm,
struct device *parent)
#define SCHIZO_STRBUF_CONTROL		(0x02800UL)
#define SCHIZO_STRBUF_FLUSH		(0x02808UL)
#define SCHIZO_STRBUF_FSYNC		(0x02810UL)
#define SCHIZO_STRBUF_CTXFLUSH		(0x02818UL)
#define SCHIZO_STRBUF_CTXMATCH		(0x10000UL)
static void schizo_pbm_strbuf_init(struct pci_pbm_info *pbm)
#define SCHIZO_IOMMU_CONTROL		(0x00200UL)
#define SCHIZO_IOMMU_TSBBASE		(0x00208UL)
#define SCHIZO_IOMMU_FLUSH		(0x00210UL)
#define SCHIZO_IOMMU_CTXFLUSH		(0x00218UL)
static int schizo_pbm_iommu_init(struct pci_pbm_info *pbm)
#define SCHIZO_PCI_IRQ_RETRY	(0x1a00UL)
#define  SCHIZO_IRQ_RETRY_INF	 0xffUL
#define SCHIZO_PCI_DIAG			(0x2020UL)
#define  SCHIZO_PCIDIAG_D_BADECC	(1UL << 10UL)
#define  SCHIZO_PCIDIAG_D_BYPASS	(1UL <<  9UL)
#define  SCHIZO_PCIDIAG_D_TTO		(1UL <<  8UL)
#define  SCHIZO_PCIDIAG_D_RTRYARB	(1UL <<  7UL)
#define  SCHIZO_PCIDIAG_D_RETRY		(1UL <<  6UL)
#define  SCHIZO_PCIDIAG_D_INTSYNC	(1UL <<  5UL)
#define  SCHIZO_PCIDIAG_I_DMA_PARITY	(1UL <<  3UL)
#define  SCHIZO_PCIDIAG_I_PIOD_PARITY	(1UL <<  2UL)
#define  SCHIZO_PCIDIAG_I_PIOA_PARITY	(1UL <<  1UL)
#define TOMATILLO_PCI_IOC_CSR		(0x2248UL)
#define TOMATILLO_IOC_PART_WPENAB	0x0000000000080000UL
#define TOMATILLO_IOC_RDMULT_PENAB	0x0000000000040000UL
#define TOMATILLO_IOC_RDONE_PENAB	0x0000000000020000UL
#define TOMATILLO_IOC_RDLINE_PENAB	0x0000000000010000UL
#define TOMATILLO_IOC_RDMULT_PLEN	0x000000000000c000UL
#define TOMATILLO_IOC_RDMULT_PLEN_SHIFT	14UL
#define TOMATILLO_IOC_RDONE_PLEN	0x0000000000003000UL
#define TOMATILLO_IOC_RDONE_PLEN_SHIFT	12UL
#define TOMATILLO_IOC_RDLINE_PLEN	0x0000000000000c00UL
#define TOMATILLO_IOC_RDLINE_PLEN_SHIFT	10UL
#define TOMATILLO_IOC_PREF_OFF		0x00000000000003f8UL
#define TOMATILLO_IOC_PREF_OFF_SHIFT	3UL
#define TOMATILLO_IOC_RDMULT_CPENAB	0x0000000000000004UL
#define TOMATILLO_IOC_RDONE_CPENAB	0x0000000000000002UL
#define TOMATILLO_IOC_RDLINE_CPENAB	0x0000000000000001UL
#define TOMATILLO_PCI_IOC_TDIAG		(0x2250UL)
#define TOMATILLO_PCI_IOC_DDIAG		(0x2290UL)
static void schizo_pbm_hw_init(struct pci_pbm_info *pbm)
static int __devinit schizo_pbm_init(struct pci_pbm_info *pbm,
struct platform_device *op, u32 portid,
int chip_type)
static inline int portid_compare(u32 x, u32 y, int chip_type)
static struct pci_pbm_info * __devinit schizo_find_sibling(u32 portid,
int chip_type)
static int __devinit __schizo_init(struct platform_device *op, unsigned long chip_type)
static const struct of_device_id schizo_match[];
static int __devinit schizo_probe(struct platform_device *op)
static const struct of_device_id schizo_match[] = ;
static struct platform_driver schizo_driver = ;
static int __init schizo_init(void)
subsys_initcall(schizo_init);
